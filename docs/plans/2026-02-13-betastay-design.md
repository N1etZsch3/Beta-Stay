# BetaStay AI民宿智能定价系统 - 设计文档

## 一、系统定位与核心理念

### 产品定位

BetaStay是一个AI驱动的民宿智能定价助手，帮助房东在收益最大化和成交率之间找到最优平衡点。

### 核心设计理念

1. **LLM不碰数据** - LLM只负责理解意图、调度工具，不直接输出价格、不直接操作数据库
2. **工具层隔离** - 所有数据操作（查询、计算、写入）封装为独立工具，LLM通过工具调用完成任务
3. **人在回路** - 任何数据入库前必须经过用户确认，系统建议但用户决策
4. **输出有据可查** - 基于RAG，LLM的所有输出必须来源于已有数据，杜绝幻觉

### MVP目标

跑通最小闭环：房源录入 → 定价建议 → 反馈记录，验证核心价值后再扩展。

### 目标平台

- 国内主流平台：美团、途家
- 支持房东手动上传数据
- 竞品数据采集模块先预留接口

### 用户体系

- MVP先做单房东，后续扩展多租户SaaS

---

## 二、系统架构概览

### 整体架构分层

```
┌─────────────────────────────────────────────────┐
│                   用户层                         │
│            uni-app (移动端优先)                   │
│         仪表盘 + 对话式交互界面                    │
└─────────────────────┬───────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────┐
│                  API网关层                        │
│              FastAPI + 认证鉴权                   │
└─────────────────────┬───────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────┐
│                 AI调度层                          │
│   LangChain + Dashscope (通义千问)               │
│   意图识别 → 工具选择 → 调用执行 → 结果组织        │
└─────────────────────┬───────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────┐
│                  工具层                           │
│  ┌─────────┬─────────┬─────────┬─────────┐      │
│  │定价引擎  │数据查询  │数据录入  │外部搜索  │      │
│  └─────────┴─────────┴─────────┴─────────┘      │
└─────────────────────┬───────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────┐
│                  数据层                           │
│  PostgreSQL(业务) + Milvus(向量) + Redis(缓存)   │
└─────────────────────────────────────────────────┘
```

### 核心数据流

用户输入 → LLM解析意图 → 选择并调用工具 → 工具返回结构化结果 → LLM组织回答 → 需入库则等待用户确认 → 确认后工具执行写入

---

## 三、工具层设计

### 核心工具清单（MVP）

| 工具名称 | 职责 | 输入 | 输出 |
|---------|------|------|------|
| `房源录入工具` | 结构化、标准化房源数据 | 用户原始输入/上传文件 | 标准化房源对象（待确认） |
| `表格解析工具` | 解析上传的Excel表格，清洗、统计、结构化数据 | Excel文件(.xlsx/.xls) | 结构化数据列表（待确认） |
| `房源查询工具` | 查询已有房源信息 | 查询条件 | 房源列表/详情 |
| `定价计算工具` | 调用规则引擎计算建议价 | 房源ID + 日期范围 | 价格建议 + 计算依据 |
| `反馈记录工具` | 记录用户对建议价的反馈 | 建议ID + 采纳/拒绝/调整值 | 反馈记录（待确认） |
| `历史查询工具` | 查询定价历史和反馈记录 | 房源ID + 时间范围 | 历史记录列表 |
| `外部搜索工具` | 联网搜索周边活动/天气/新闻 | 地点 + 关键词 + 日期 | 结构化事件信息 |

### 工具设计原则

1. **单一职责** - 每个工具只做一件事，便于LLM准确选择
2. **输入输出标准化** - 统一的JSON Schema定义，便于校验和处理
3. **写操作标记** - 涉及数据写入的工具返回"待确认"状态，前端拦截展示确认框
4. **可追溯** - 每次工具调用记录日志，支持问题排查和审计

---

## 四、定价引擎设计

### 权重体系

```
最终建议价 = 基准价 × 综合调整系数

综合调整系数 = Σ(因素调整值 × 权重)
```

| 因素类别 | 权重占比 | 包含要素 |
|---------|---------|---------|
| 房东偏好 | 35% | 最低可接受价、期望收益率、空置容忍度 |
| 历史表现 | 25% | 历史成交价、成交率、用户评分趋势 |
| 时间因素 | 18% | 周末/工作日、节假日、淡旺季、提前天数 |
| 市场因素 | 12% | 竞品价格、区域供需（预留接口） |
| 基础属性 | 7% | 房型、面积、位置、设施 |
| 外部事件 | 3% | 周边活动、天气、突发新闻 |

### 引擎特性

1. **透明可解释** - 每次定价输出完整计算过程，告诉房东"为什么是这个价"
2. **边界约束** - 硬性遵守房东设定的最低价/最高价，引擎只在区间内建议
3. **权重可调** - 权重值存储在配置中，支持根据反馈数据后续调优
4. **多价格输出** - 输出"保守价/建议价/激进价"三档，供房东选择

---

## 五、数据模型设计

### 关系数据库（PostgreSQL）核心表

```
房源表 (property)
├── id, 名称, 地址, 房型, 面积, 设施配置(JSON)
├── 房东偏好: 最低价, 最高价, 期望收益率, 空置容忍度
└── 创建时间, 更新时间

定价记录表 (pricing_record)
├── id, 房源ID, 目标日期, 建议价(保守/建议/激进)
├── 计算依据(JSON): 各因素得分及权重明细
└── 创建时间

反馈记录表 (feedback)
├── id, 定价记录ID, 反馈类型(采纳/拒绝/调整)
├── 实际采用价格, 用户备注
└── 创建时间

成交记录表 (transaction)
├── id, 房源ID, 入住日期, 实际成交价
├── 来源平台, 提前预订天数
└── 创建时间
```

### 向量数据库（Milvus）

- 存储房源描述、历史对话的向量化表示
- 支持RAG检索：根据用户问题匹配相关历史数据和上下文

### Redis

- 会话状态缓存（对话上下文）
- 热点数据缓存（常用房源信息）
- 待确认操作暂存（用户确认前的数据暂存）

---

## 六、AI调度层设计

### LangChain架构（V1版本）

```
┌────────────────────────────────────────────────┐
│                  Agent 主控                      │
│         ReAct模式：思考 → 行动 → 观察            │
└───────────────────┬────────────────────────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
   ┌─────────┐ ┌─────────┐ ┌─────────┐
   │ Memory  │ │  Tools  │ │   RAG   │
   │ 会话记忆 │ │ 工具集   │ │ 检索增强 │
   └─────────┘ └─────────┘ └─────────┘
```

### 核心组件

| 组件 | 实现方式 | 职责 |
|-----|---------|------|
| LLM | Dashscope (qwen-max / qwen-plus) | 意图理解、推理决策 |
| Agent | LangChain Agent with Tools | 根据意图选择并调用工具 |
| Memory | ConversationBufferWindowMemory + Redis + PostgreSQL | 保持对话上下文连贯 |
| RAG | Milvus向量检索 + 上下文注入 | 确保输出基于已有数据 |

### 会话记忆持久化方案

```
会话表 (conversation)
├── id, 用户ID, 会话标题, 创建时间, 最后活跃时间
└── 状态(进行中/已归档)

消息表 (message)
├── id, 会话ID, 角色(user/assistant/system/tool)
├── 内容, 工具调用记录(JSON)
└── 创建时间
```

| 层级 | 存储 | 用途 |
|-----|------|------|
| 热数据 | Redis | 当前活跃会话的最近N轮对话，快速读取 |
| 持久化 | PostgreSQL | 全量会话历史，支持回溯和分析 |
| 向量化 | Milvus | 历史对话向量化，支持语义检索相关上下文 |

### 记忆加载策略

1. **会话恢复** - 用户打开历史会话时，从PostgreSQL加载完整历史
2. **上下文窗口** - 当前对话取最近10-20轮放入Prompt
3. **长期记忆检索** - 通过RAG检索历史会话中的相关片段，注入当前上下文

### 严格输出约束实现

1. **System Prompt硬约束** - 明确要求"只能基于检索到的数据回答，无数据则明确告知"
2. **RAG前置** - 每次回答前先检索相关数据，无命中则限制输出范围
3. **结构化输出** - 关键输出（如价格建议）必须来自工具返回，LLM只做组织呈现

---

## 七、前端交互设计

### uni-app页面结构（MVP）

```
├── 首页/仪表盘
│   ├── 房源卡片（当前房源概览）
│   ├── 今日建议价快览
│   └── 快捷入口（对话、录入、历史）
│
├── 对话页
│   ├── 聊天界面（支持历史会话切换）
│   ├── 消息气泡（文本 + 结构化卡片）
│   └── 确认弹窗（数据入库前拦截确认）
│
├── 房源管理
│   ├── 房源详情/编辑
│   └── 偏好设置（最低价、期望收益等）
│
└── 历史记录
    ├── 定价历史列表
    └── 反馈记录查看
```

### 关键交互设计

| 场景 | 交互方式 |
|-----|---------|
| 获取定价建议 | 对话输入 → AI返回价格卡片（保守/建议/激进三档） |
| 录入房源 | 对话引导 或 表单填写 → 预览确认 → 入库 |
| 确认入库 | 底部弹出确认面板，展示待入库数据摘要，用户点击确认/取消 |
| 反馈定价 | 价格卡片上直接操作：采纳/拒绝/手动调整 |

### 消息卡片类型

- 文本消息：普通对话
- 价格建议卡片：三档价格 + 计算依据折叠展示
- 数据确认卡片：待入库数据预览 + 确认/取消按钮
- 房源信息卡片：房源摘要展示

---

## 八、MVP实现路径

### 阶段划分

**第一阶段：基础骨架**
- 项目结构搭建（FastAPI + uni-app）
- 数据库初始化（PostgreSQL + Redis）
- Dashscope接入验证
- 基础API框架

**第二阶段：核心链路**
- 房源录入工具 + 房源表
- 定价引擎（简化版，先支持基础属性+房东偏好）
- LangChain Agent + 工具绑定
- 对话API + 会话持久化

**第三阶段：闭环完成**
- 反馈记录工具
- 前端对话页 + 确认交互
- 价格建议卡片展示
- 最小闭环跑通验证

**第四阶段：增强迭代**
- 向量数据库接入（RAG）
- 定价引擎完善（加入时间、历史因素）
- 仪表盘页面
- 外部搜索工具

### 项目目录结构

```
BetaStay/
├── backend/
│   ├── app/
│   │   ├── api/          # FastAPI路由
│   │   ├── core/         # 配置、安全
│   │   ├── models/       # 数据模型
│   │   ├── services/     # 业务逻辑
│   │   ├── tools/        # LangChain工具
│   │   ├── engine/       # 定价引擎
│   │   └── agent/        # LangChain Agent
│   ├── tests/
│   └── requirements.txt
│
├── frontend/
│   └── uni-app项目结构
│
└── docs/
    └── plans/
```

---

## 九、技术规范与约束

### 后端规范

| 项目 | 选择 |
|-----|------|
| Python版本 | 3.14 |
| Web框架 | FastAPI |
| ORM | SQLAlchemy 2.0 |
| AI框架 | LangChain 1.0 |
| LLM | Dashscope (qwen-max / qwen-plus) |
| 数据库 | PostgreSQL 15+ |
| 向量库 | Milvus (后续阶段) |
| 缓存 | Redis 7+ |
| API规范 | RESTful + WebSocket(对话流式) |

### 前端规范

| 项目 | 选择 |
|-----|------|
| 框架 | Vue3 + uni-app |
| 状态管理 | Pinia |
| UI组件 | uni-ui 或 uView |
| 网络请求 | uni.request 封装 |

### 安全约束

1. **LLM输出不可信** - 任何LLM输出不直接用于数据操作，必须经过工具层处理
2. **入库必确认** - 写操作必须用户显式确认
3. **敏感数据加密** - 房东偏好、定价数据加密存储
4. **接口鉴权** - JWT Token认证，后续支持多租户隔离

### 可扩展性预留

- 数据采集模块接口预留
- 多平台对接接口预留
- 多租户数据隔离结构预留

### 学习成长机制

- **短期：反馈学习** - 房东采纳/拒绝建议价格，系统记录并调整后续推荐
- **长期：成交验证** - 追踪实际成交数据，对比预测价格，自动修正模型参数
